services:
  bitbucket:
    image: atlassian/bitbucket:latest
    ports:
      - "7990:7990"
      - "7999:7999"
    environment:
      BITBUCKET_SETUP_TOKEN: ${BITBUCKET_SETUP_TOKEN:-}
      BITBUCKET_SETUP_DISPLAYNAME: ${BITBUCKET_SETUP_DISPLAYNAME:-Bitbucket}
      BITBUCKET_SETUP_EMAIL: ${BITBUCKET_SETUP_EMAIL:-admin@example.com}
    volumes:
      - bitbucket-data:/var/atlassian/application-data/bitbucket
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7990/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  fast-agent:
    build: .
    ports:
      - "8000:8000"
    environment:
      # Google API Configuration (required for fast-agent)
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

      # Bitbucket Server Configuration (required for pull requests)
      BITBUCKET_URL: ${BITBUCKET_URL:-}
      BITBUCKET_TOKEN: ${BITBUCKET_TOKEN:-}
      BITBUCKET_WORKSPACE: ${BITBUCKET_WORKSPACE:-}

      # JIRA Configuration (required for ticket reading)
      JIRA_URL: ${JIRA_URL:-}
      JIRA_USERNAME: ${JIRA_USERNAME:-}
      JIRA_TOKEN: ${JIRA_TOKEN:-}

      # Confluence Configuration (optional, part of Atlassian integration)
      CONFLUENCE_URL: ${CONFLUENCE_URL:-}
      CONFLUENCE_USERNAME: ${CONFLUENCE_USERNAME:-}
      CONFLUENCE_TOKEN: ${CONFLUENCE_TOKEN:-}

    volumes:
      # Optional: mount local config for customization
      - ./fastagent.config.yaml:/app/fastagent.config.yaml:ro

    command: go

volumes:
  bitbucket-data:
